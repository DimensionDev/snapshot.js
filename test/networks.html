<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Snapshot Networks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </script>
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="icon" href="https://snapshot.org/favicon.png">
  <script src="https://unpkg.com/@uiw/copy-to-clipboard@1.0.10/dist/copy-to-clipboard.umd.js"></script>
  <script src="../dist/snapshot.min.js"></script>
  <script type="text/javascript" integrity="sha384-xA6XksA+S81KMKVo5shbejvuHxb0UMBTEG1c2ifc8SsBJKISpURzwy2Y8dDo0fli"
    crossorigin="anonymous" src="https://cdn-cors.ethers.io/lib/ethers-5.4.1.umd.min.js">
  </script>
  <script src="https://unpkg.com/vue@next"></script>
  <style>
    [v-cloak] {
      display: none;
    }

  </style>
  <script>
    window.addEventListener('load', async function () {
      let networks = {};
      const providers = {};

      try {
        const res = await fetch('../src/networks.json')
        networks = await res.json();
      } catch (error) {
        console.log(error)
      }

      const app = Vue.createApp({
        data() {
          return {
            selectedNetwork: null,
            editNetwork: false,
            error: false,
            newNetworkObject: '',
            networks
          }
        },
        methods: {
          changeNetworksObject() {
            try {
              this.networks[this.selectedNetwork.key] = JSON.parse(this.newNetworkObject)
              this.selectNetwork(this.selectedNetwork.key);
            } catch (error) {
              console.log(error.message)
              this.error = error.message
            }
          },
          editNetworkButtonClick() {
            this.editNetwork = !this.editNetwork;
            if (this.editNetwork) {
              this.newNetworkObject = JSON.stringify(this.networks[this.selectedNetwork.key], null, 2)
            }
          },
          async selectNetwork(networkKey) {
            this.error = false;
            this.editNetwork = false;
            this.newNetworkObject = '';
            this.selectedNetwork = null;
            this.selectedNetwork = JSON.parse(JSON.stringify(networks[networkKey]));
            this.selectedNetwork.rpcStatus = JSON.parse(JSON.stringify(this.selectedNetwork.rpc)).map((rpc,
              index) => ({
              url: rpc,
              index,
              status: {
                loading: true
              }
            }))

            // Make sure all the RPCs are loaded at the same time and then check multicall response time
            let rpcCompletedCount = 0;
            this.selectedNetwork.rpcStatus.forEach(async (rpc) => {
              let provider = null;
              let latestBlockNumber, fullArchiveNode = '...';
              let errors = [];

              try {
                provider = new ethers.providers.StaticJsonRpcProvider(rpc)
              } catch (error) {
                errors.push('Provider Error: ' + error.message)
                console.log('Provider Error', error)
              }

              // Latest Block
              try {
                latestBlockNumber = await provider.getBlockNumber();
              } catch (error) {
                latestBlockNumber = 'ERROR!';
                errors.push('getBlockNumber Error: ' + error.message)
                console.log('getBlockNumber Error', error)
              }

              // Is archive node
              try {
                fullArchiveNode = await provider.getBalance(this.selectedNetwork.multicall, 0);
                fullArchiveNode = fullArchiveNode >= 0 ? 'Yes' : 'No';
              } catch (error) {
                fullArchiveNode = 'ERROR!';
                errors.push('fullArchiveNode Error: ' + error.message)
                console.log('fullArchiveNode', error);
              }

              this.selectedNetwork.rpcStatus[rpc.index] = {
                ...rpc,
                status: {
                  latestBlockNumber,
                  fullArchiveNode,
                  errors,
                  multicall: '...',
                  loading: false
                }
              }
              rpcCompletedCount++;
              // If all calls are done, call the multicall
              if (rpcCompletedCount === this.selectedNetwork.rpcStatus.length) {
                for (const rpc of this.selectedNetwork.rpcStatus) {
                  try {
                    const abi = [
                      'function aggregate(tuple(address target, bytes callData)[] calls) view returns (uint256 blockNumber, bytes[] returnData)',
                      'function getEthBalance(address addr) view returns (uint256 balance)'
                    ]
                    const addresses = [this.selectedNetwork.multicall];
                    const multicallStart = performance.now();

                    const response = await snapshot.utils.multicall(
                      this.selectedNetwork.key,
                      provider,
                      abi,
                      addresses.map((address) => [
                        this.selectedNetwork.multicall,
                        'getEthBalance',
                        [address]
                      ]), {
                        blockTag: 'latest'
                      }
                    );
                    const multicallEnd = performance.now();
                    multicallTime = multicallEnd - multicallStart;

                    rpc.status.multicall = multicallTime.toFixed(2) + " ms"
                  } catch (error) {
                    rpc.status.multicall = 'ERROR!'
                    rpc.status.errors.push('multicall Error: ' + error.message)
                    console.log('multicall', error);
                  }
                }
              }
            })
          },
          copy(text) {
            if (typeof text === 'object') text = JSON.stringify(text);
            window.copyTextToClipboard(text)
          }
        }
      });

      const vm = app.mount('#app')
    })

  </script>
</head>

<body class="m-2">
  <h2 class="text-2xl tracking-tight font-extrabold text-gray-900">
    <span><img class="inline w-6 pr-1"
        src="https://raw.githubusercontent.com/snapshot-labs/brand/master/icon/icon.svg" /> </span>
    <span>Network</span>
    <span class="text-indigo-600">Tester</span>
  </h2>
  <div id="app">
    <div class="flex mt-4 mb-10" v-cloak>
      <div class="relative inline-block text-left">
        <div
          class="mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none"
          role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
          <a href="#"
            class="flex hover:bg-purple-700 focus-within:bg-purple-700 hover:text-white focus-within:text-white p-1 text-gray-700"
            role="none" v-for="(item, index) in Object.values(networks)" :key="index" @click="selectNetwork(item.key)">
            <div>
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                {{ item.key }}
              </span>
            </div>
            <div class=" px-2 py-1 text-sm " role="menuitem" tabindex="-1" id="menu-item-0">{{item.name}}
            </div>
          </a>
        </div>
      </div>
      <div class="flex-auto p-4">
        <h3 class="text-xl font-blod" v-if="!selectedNetwork">
          Select a network from menu
        </h3>
        <div v-if="selectedNetwork" class="mt-4">
          <div class="lg:flex lg:items-center lg:justify-between mb-4">
            <div class="flex-1 min-w-0">
              <h2 class="text-3xl">
                {{selectedNetwork.name}}
                <span v-if="selectedNetwork"
                  class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                  {{ selectedNetwork.key }}
                </span>
              </h2>
              <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:mt-0 sm:space-x-6">
                <div class="mt-2 flex items-center text-sm text-gray-500">
                  Number of RPC: {{selectedNetwork.rpc.length}}
                </div>
              </div>
            </div>
            <div class="mt-5 flex">
              <button type="button" @click="editNetworkButtonClick"
                class="items-center px-4 py-2 mx-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Edit Network
              </button>
              <button type="button" @click="selectNetwork(selectedNetwork.key)"
                class="items-center px-4 py-2 mx-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Refresh
                <img class="inline w-4" alt="svgImg"
                  src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjBweCIgeT0iMHB4Igp3aWR0aD0iMjQiIGhlaWdodD0iMjQiCnZpZXdCb3g9IjAgMCAxNzIgMTcyIgpzdHlsZT0iIGZpbGw6IzAwMDAwMDsiPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0ibm9uemVybyIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1saW5lY2FwPSJidXR0IiBzdHJva2UtbGluZWpvaW49Im1pdGVyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS1kYXNoYXJyYXk9IiIgc3Ryb2tlLWRhc2hvZmZzZXQ9IjAiIGZvbnQtZmFtaWx5PSJub25lIiBmb250LXdlaWdodD0ibm9uZSIgZm9udC1zaXplPSJub25lIiB0ZXh0LWFuY2hvcj0ibm9uZSIgc3R5bGU9Im1peC1ibGVuZC1tb2RlOiBub3JtYWwiPjxwYXRoIGQ9Ik0wLDE3MnYtMTcyaDE3MnYxNzJ6IiBmaWxsPSJub25lIj48L3BhdGg+PGcgZmlsbD0iI2ZmZmZmZiI+PHBhdGggZD0iTTg2LDBsLTI4LjY2NjY3LDI4LjY2NjY3bDI4LjY2NjY3LDI4LjY2NjY3di0yMS41YzI3LjY1NjE3LDAgNTAuMTY2NjcsMjIuNTAzMzMgNTAuMTY2NjcsNTAuMTY2NjdjMCw2LjMwNjY3IC0xLjIyMzcxLDEyLjMyNzM0IC0zLjM1OTM3LDE3Ljg4ODY3bDEwLjg2MTk4LDEwLjg0Nzk4YzQuMzM1ODMsLTguNjY0NSA2LjgzMDczLC0xOC40MDIzMiA2LjgzMDczLC0yOC43MzY2NmMwLC0zNS41NjEgLTI4LjkzMTgzLC02NC41IC02NC41LC02NC41ek0yOC4zMzA3Myw1Ny4yNjMzNWMtNC4zMzU4Myw4LjY2NDUgLTYuODMwNzMsMTguNDAyMzIgLTYuODMwNzMsMjguNzM2NjVjMCwzNS41NjEgMjguOTMxODMsNjQuNSA2NC41LDY0LjV2MjEuNWwyOC42NjY2NywtMjguNjY2NjdsLTI4LjY2NjY3LC0yOC42NjY2N3YyMS41Yy0yNy42NTYxNywwIC01MC4xNjY2NywtMjIuNTAzMzMgLTUwLjE2NjY3LC01MC4xNjY2N2MwLC02LjMwNjY3IDEuMjIzNzEsLTEyLjMyNzM0IDMuMzU5MzgsLTE3Ljg4ODY3eiI+PC9wYXRoPjwvZz48L2c+PC9zdmc+" />
              </button>
            </div>
          </div>
          <div v-if="editNetwork">
            <h3>Edit Network Object</h3>
            <textarea v-model="newNetworkObject"
              class="form-textarea mt-1 block w-full input text-left p-2 border border-gray-300 rounded-md" rows="10"
              placeholder="Enter Network"></textarea>
            <button type="button" @click="editNetwork = false"
              class="px-4 py-2 my-2 mr-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Cancel
            </button>
            <button type="button" @click="changeNetworksObject"
              class="px-4 py-2 my-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Apply
            </button>
          </div>
          <div v-if="error">ERROR: {{ error }}</div>
          <div class="flex flex-col mt-2">
            <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      RPC
                    </th>
                    <th scope="col"
                      class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Latest Block
                    </th>
                    <th scope="col"
                      class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Full archive node
                    </th>
                    <th scope="col"
                      class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Multicall Time
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr v-for="(rpc, index) in selectedNetwork.rpcStatus" :key="rpc.index">
                    <td class="p-2 border-b-1 border-gray-600">
                      <div>
                        <div class="ml-4">
                          <div>
                            <img class="w-4 cursor-pointer" @click="copy(rpc.url)"
                              src="https://img.icons8.com/material-outlined/24/000000/copy.png" />
                            <h3 class="text-sm leading-6 font-medium text-gray-900" style="width: 500px;
                                  overflow: hidden;
                                  text-overflow: ellipsis;">
                              {{rpc.url}}
                            </h3>
                          </div>

                        </div>
                      </div>
                    </td>
                    <td v-if="rpc.status.loading" colspan="3">
                      <div class="animate-pulse flex">
                        <div class="h-4 bg-blue-400 rounded w-5/6"></div>
                      </div>
                    </td>
                    <td class="p-2 border-b-1 border-gray-600 text-center">
                      <a target="blank" :href="`${selectedNetwork.explorer}/block/${rpc.status.latestBlockNumber}`">
                        <h2 class="title-font font-medium text-2xl text-gray-900">
                          {{rpc.status.latestBlockNumber}}
                        </h2>
                      </a>
                    </td>
                    <td class="p-2 border-b-1 border-gray-600 text-center">
                      <h2 class="title-font font-medium text-2xl text-gray-900">
                        {{rpc.status.fullArchiveNode}}
                      </h2>
                    </td>
                    <td class="p-2 border-b-1 border-gray-600 text-center">
                      <h2 class="title-font font-medium text-2xl text-gray-900">
                        {{rpc.status.multicall}}
                      </h2>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-6">
              <div v-for="(rpc, index) in selectedNetwork.rpcStatus" :key="rpc.index">
                <div class="flex max-w-20 overflow-hidden bg-white rounded-lg shadow-md dark:bg-gray-800 m-4"
                  v-if="rpc.status.errors && rpc.status.errors.length > 0">
                  <div class="flex items-center justify-center bg-red-500">
                    <svg class="w-6 h-6 text-white fill-current" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M20 3.36667C10.8167 3.36667 3.3667 10.8167 3.3667 20C3.3667 29.1833 10.8167 36.6333 20 36.6333C29.1834 36.6333 36.6334 29.1833 36.6334 20C36.6334 10.8167 29.1834 3.36667 20 3.36667ZM19.1334 33.3333V22.9H13.3334L21.6667 6.66667V17.1H27.25L19.1334 33.3333Z" />
                    </svg>
                  </div>

                  <div class="px-4 py-2 -mx-3">
                    <div class="mx-3">
                      <span class="font-semibold text-red-500 dark:text-red-400">Errors for: {{rpc.url}}</span>
                      <p class="text-sm text-gray-600 dark:text-gray-200 py-2"
                        v-for="(error, index) in rpc.status.errors" :key="index">
                        {{ error }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>

</html>
